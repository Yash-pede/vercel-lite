worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # DNS resolvers so Nginx can resolve dynamic proxy_pass hostnames
    resolver 8.8.8.8 1.1.1.1 ipv6=off;

    # Extract subdomain from Host header (assuming domain is yashpede.in)
    map $host $subdomain {
        ~^(?<sub>[^.]+)\.yashpede\.in$ $sub;
        default "default";
    }

    server {
        listen 80;
        server_name ~^(?<sub>[^.]+)\.yashpede\.in$;

        # Access and error logs for debugging
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log debug;

        # Base URL for S3 bucket path depending on subdomain
        set $s3_base https://vercel-lite.s3.ap-south-1.amazonaws.com/__outputs/$subdomain;

        location / {
            # Proxy all requests here
            proxy_intercept_errors on;

            proxy_pass $s3_base$request_uri;
            proxy_set_header Host vercel-lite.s3.ap-south-1.amazonaws.com;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # If requested file is not found on S3 (404), fallback to index.html for SPA routing
            error_page 404 = @index_fallback;
        }

        location @index_fallback {
            proxy_pass $s3_base/index.html;
            proxy_set_header Host vercel-lite.s3.ap-south-1.amazonaws.com;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
